<!DOCTYPE html>
<html lang="ko">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="./css/style.css" />

    <!-- jquery  -->
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>

    <!-- blockchain-->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script type="text/javascript" src="./js/abi.js"></script>
    <script src="./js/jscript.js"></script>

    <script>
      $(window).on("load", async function () {
        // 1) 지갑 초기화가 끝날 때까지 기다리는 유틸리티
        async function waitForContract(timeoutMs) {
          const start = Date.now();
          while (!window.mintingEvent) {
            if (Date.now() - start > timeoutMs) {
              throw new Error("mintingEvent 초기화 타임아웃");
            }
            await new Promise((resolve) => setTimeout(resolve, 200));
          }
          return window.mintingEvent;
        }

        try {
          // 2) initWeb3Context()가 만들어 줄 때까지 기다린다
          await waitForContract(5000);
        } catch (err) {
          alert(
            "컨트랙트가 초기화되지 않았습니다. 지갑 연결 후 다시 시도하세요."
          );
          console.error(err);
          return;
        }

        // 3) 아래부터 기존 mynft 로직 실행
        const accounts =
          Array.isArray(window.accounts) && window.accounts.length
            ? window.accounts
            : await window.web3.eth.getAccounts();
        const activeAccount = accounts[0];

        if (!activeAccount) {
          alert("활성화된 지갑 계정을 찾을 수 없습니다.");
          return;
        }

        $("#showAccount").text(activeAccount);

        const contractAddress = window.mintingEvent.options.address;

        let approvalState = false;
        try {
          approvalState = await window.mintingEvent.methods
            .isApprovedForAll(activeAccount, contractAddress)
            .call();
        } catch (error) {
          console.warn("승인 상태 조회 실패", error);
        }

        $("#btn_setApprovalForAll").text(
          approvalState ? "거래상태 : 거래가능" : "거래상태 : 거래중지"
        );

        let saleList = [];
        try {
          saleList = await window.mintingEvent.methods
            .getSaleNftTokens()
            .call({ from: activeAccount });
        } catch (error) {
          const message = error?.message || error?.data?.message || "";
          const isMissingTrie =
            typeof message === "string" &&
            message.includes("missing trie node");
          if (isMissingTrie) {
            console.warn(
              "판매 목록 조회 중 missing trie node 오류가 발생했습니다. 빈 목록으로 처리합니다.",
              error
            );
            saleList = [];
          } else {
            console.error("판매 목록 조회 실패", error);
            $("#dynamicTbody").html(
              '<tr><td colspan="6" class="text-center">판매 목록을 가져오는 중 오류가 발생했습니다.</td></tr>'
            );
            return;
          }
        }

        if (!Array.isArray(saleList) || saleList.length === 0) {
          $("#dynamicTbody").html(
            '<tr><td colspan="6" class="text-center">자료없음</td></tr>'
          );
          return;
        }

        for (let index = 0; index < saleList.length; index++) {
          const item = saleList[index];
          const tokenId = item.nftTokenId;
          const price = item.price;
          const metadata = await fetchMetadata(item.nftTokenURI);

          const name = metadata?.name || "-";
          const image = metadata?.image || "";

          const rowHtml = `
          <tr id="tr_${tokenId}">
            <td>${index + 1}</td>
            <td>${tokenId}</td>
            <td>${price}</td>
            <td>${name}</td>
            <td>${image ? `<img src="${image}" width="100" />` : "-"}</td>
            <td>
              <a href="./mynft_detail.html?tokenId=${tokenId}" class="btn btn-secondary btn-flat">상세보기</a>
              <button type="button" class="btn btn-success btn_buy" data-bs-toggle="modal" data-bs-target="#saleModal" data-token-id="${tokenId}" data-price="${price}">구매하기</button>
            </td>
          </tr>`;

          $("#dynamicTbody").append(rowHtml);
        }

        async function fetchMetadata(uri) {
          if (!uri) {
            return null;
          }
          try {
            const response = await fetch(uri);
            if (!response.ok) {
              throw new Error("HTTP " + response.status);
            }
            return await response.json();
          } catch (error) {
            console.warn("메타데이터를 가져오지 못했습니다.", uri, error);
            return null;
          }
        }

        function extractRpcErrorMessage(error) {
          if (!error) {
            return "";
          }
          if (error.data && error.data.message) {
            return error.data.message;
          }
          if (error.error && error.error.message) {
            return error.error.message;
          }
          if (error.message) {
            return error.message;
          }
          return "";
        }

        function buildSendOptions(account, overrides) {
          const storageKey =
            typeof STORAGE_KEYS !== "undefined" && STORAGE_KEYS.network
              ? STORAGE_KEYS.network
              : "blockChainNetwork";
          const networkKey = localStorage.getItem(storageKey) || "";
          const base = Object.assign({ from: account }, overrides || {});
          if (networkKey === "POLYGON_AMOY") {
            if (!base.gasPrice) {
              base.gasPrice = "50000000000";
            }
            if (!base.gas) {
              base.gas = "500000";
            }
          }
          return base;
        }

        $(document).on("click", ".btn_buy", function () {
          const tokenId = $(this).data("token-id");
          const price = $(this).data("price");
          $("#saleModal").data("token-id", tokenId);
          $("#saleModal").data("price", price);
          $("#price").val(price);
          $(".modal-title").text("구매하기");
        });

        $(".btn_buySubmit").on("click", async function () {
          const tokenId = $("#saleModal").data("token-id");
          const price = $("#saleModal").data("price") || $("#price").val();

          if (!tokenId) {
            alert("구매할 토큰을 찾을 수 없습니다.");
            return;
          }

          try {
            const ownerAddress = await window.mintingEvent.methods
              .ownerOf(tokenId)
              .call({ from: activeAccount });
            if (ownerAddress.toLowerCase() === activeAccount.toLowerCase()) {
              alert("제품 소유자는 구매할 수 없습니다.");
              return;
            }

            const sendOptions = buildSendOptions(activeAccount, {
              value: price,
            });
            const receipt = await window.mintingEvent.methods
              .buyNftToken(tokenId)
              .send(sendOptions);
            console.log("구매 성공", receipt);
            location.reload();
          } catch (error) {
            console.error("구매 실패", error);
            const message =
              extractRpcErrorMessage(error) || "구매 중 오류가 발생했습니다.";
            alert(message);
          }
        });

        $("#btn_setApprovalForAll").on("click", async function () {
          try {
            const approvalOptions = buildSendOptions(activeAccount);
            await window.mintingEvent.methods
              .setApprovalForAll(contractAddress, true)
              .send(approvalOptions);
            alert("승인 상태가 거래가능으로 변경되었습니다.");
            $("#btn_setApprovalForAll").text("거래상태 : 거래가능");
          } catch (error) {
            console.error("승인 상태 변경 실패", error);
            alert("승인 상태 변경 중 오류가 발생했습니다.");
          }
        });
      });
    </script>
  </head>

  <body data-page="sale">
    <nav
      class="navbar navbar-expand-lg navbar-dark bg-dark"
      aria-label="Eighth navbar example"
    >
      <div class="container">
        <a class="navbar-brand" href="#">NFT</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarsExample07"
          aria-controls="navbarsExample07"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsExample07">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="index.html"
                >민팅하기</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="mynft.html">My-NFT</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="sale.html">판매</a>
            </li>
          </ul>

          <div class="d-flex">
            <button
              type="button"
              class="btn btn-warning col-md-6"
              id="btn_setApprovalForAll"
            >
              거래상태
            </button>
            &nbsp;&nbsp;
            <span class="col-md-7">
              <select
                class="form-select"
                aria-label="블록체인 네트워크"
                id="selectNetwork"
              >
                <option value="">네트워크를 선택하세요</option>
                <option value="POLYGON_AMOY">POLYGON Amoy</option>
                <option value="ETH_SEPOLIA">이더리움 Sepolia</option>
                <option value="KAIA_KAIROS">카이아 Kairos</option>
              </select>
            </span>
          </div>
        </div>
      </div>
    </nav>

    <div class="container">
      <h1 class="bd-title text-center">판매중인 NFT</h1>

      <div class="input-group mb-3">
        <div class="col-12 py-3">
          <span class="form-control" id="resultbrowsers"></span>
        </div>

        <div class="input-group-prepend">
          <span class="input-group-text">계정</span>
        </div>
        <span class="form-control" id="showAccount"></span>
      </div>

      <div class="box-body" style="min-height: 500px">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>순서</th>
              <th>TokenId</th>
              <th>금액</th>
              <th>창작자</th>
              <th>이미지</th>
              <th>비고</th>
            </tr>
          </thead>
          <tbody id="dynamicTbody"></tbody>
        </table>
      </div>
    </div>

    <footer class="footer" style="margin-top: 30px">
      <div class="container">
        <span class="text-muted">2025년 NFT 마켓플레이스</span>
      </div>
    </footer>

    <div
      class="modal fade"
      id="saleModal"
      tabindex="-1"
      aria-labelledby="buyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="buyModalLabel">구매하기</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input
              type="number"
              class="form-control"
              id="price"
              onkeydown="return onlyNumber(event);"
            />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary btn_buySubmit">
              구매하기
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
