<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IPFS ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .preview-image {
            max-width: 100%;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .code-block {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .result-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>

    <script>
        $(window).on("load", function () {
            const IPFS_API_URL = "http://localhost:5001";
            const IPFS_GATEWAY_URL = "http://localhost:8080/ipfs/";
            const EXTERNAL_GATEWAY_URL = "https://ipfs.io/ipfs/";

            let uploadedHash = "";

            const setStatus = (selector, message, level) => {
                $(selector).html(`<div class="status ${level}">${message}</div>`);
            };

            const formatFileInfo = (file) =>
                `íŒŒì¼ëª…: ${file.name}<br>í¬ê¸°: ${(file.size / 1024).toFixed(2)} KB<br>íƒ€ì…: ${file.type || "ì•Œ ìˆ˜ ì—†ìŒ"}`;

            const requestIPFS = (formData, onSuccess, onError) => {
                $.ajax({
                    url: `${IPFS_API_URL}/api/v0/add`,
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        const result = typeof data === "string" ? JSON.parse(data) : data;
                        if (!result?.Hash) {
                            onError("ì‘ë‹µì—ì„œ CIDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                            return;
                        }
                        onSuccess(result.Hash, result);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("IPFS ì—…ë¡œë“œ ì‹¤íŒ¨:", textStatus, errorThrown);
                        onError(`${textStatus}<br>${errorThrown || "IPFS ë°ëª¬ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."}`);
                    }
                });
            };

            const checkIPFSStatus = () => {
                $.ajax({
                    url: `${IPFS_API_URL}/api/v0/version`,
                    type: "POST",
                    success: function (data) {
                        const result = typeof data === "string" ? JSON.parse(data) : data;
                        setStatus(
                            "#ipfs-status",
                            `<strong>âœ“ IPFS ì—°ê²° ì„±ê³µ!</strong><br>Version: ${result.Version}<br>API: ${IPFS_API_URL}`,
                            "success"
                        );
                    },
                    error: function () {
                        setStatus(
                            "#ipfs-status",
                            "<strong>âœ— IPFS ì—°ê²° ì‹¤íŒ¨</strong><br>IPFS ë°ëª¬ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.<br>í„°ë¯¸ë„ì—ì„œ: <code>ipfs daemon</code>",
                            "error"
                        );
                    }
                });
            };

            checkIPFSStatus();

            $("#uploadfile").on("change", function (e) {
                const file = e.target.files[0];
                const rawPath = e.target.value || "";
                if (!file) {
                    setStatus("#file-info", "íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
                    $("#preview").empty();
                    return;
                }

                const pathLine = rawPath ? `<br>ê²½ë¡œ: ${rawPath}` : "";
                setStatus(
                    "#file-info",
                    `<strong>ì„ íƒëœ íŒŒì¼:</strong><br>${formatFileInfo(file)}${pathLine}`,
                    "info"
                );

                if (file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        $("#preview").html(`<img src="${evt.target.result}" class="preview-image" alt="ë¯¸ë¦¬ë³´ê¸°">`);
                    };
                    reader.readAsDataURL(file);
                } else {
                    $("#preview").empty();
                }
            });

            $("#btn-upload").on("click", function () {
                const file = document.getElementById("uploadfile").files[0];
                if (!file) {
                    alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                    return;
                }

                setStatus("#upload-result", "ì—…ë¡œë“œ ì¤‘...", "info");

                const formData = new FormData();
                formData.append("file", file);

                requestIPFS(
                    formData,
                    function (hash) {
                        uploadedHash = hash;
                        const localUrl = `${IPFS_GATEWAY_URL}${hash}`;
                        const externalUrl = `${EXTERNAL_GATEWAY_URL}${hash}`;

                        const ipfsUri = `ipfs://${hash}`;

                        setStatus(
                            "#upload-result",
                            `<strong>âœ“ ì—…ë¡œë“œ ì„±ê³µ!</strong><br><br>` +
                                `<strong>IPFS Hash:</strong><br><code>${hash}</code><br><br>` +
                                `<strong>IPFS URI:</strong><br><code>${ipfsUri}</code><br><br>` +
                                `<strong>ë¡œì»¬ Gateway URL:</strong><br><a href="${localUrl}" target="_blank">${localUrl}</a><br><br>` +
                                `<strong>ì™¸ë¶€ Gateway URL:</strong><br><a href="${externalUrl}" target="_blank">${externalUrl}</a><br><br>` +
                                `<button class="btn btn-sm btn-primary" data-ipfs-hash="${hash}" id="btn-test-metadata">ë©”íƒ€ë°ì´í„° í…ŒìŠ¤íŠ¸</button>`,
                            "success"
                        );

                        if (file.type.startsWith("image/")) {
                            $("#uploaded-preview").html(
                                `<h5 class="mt-4">ì—…ë¡œë“œëœ ì´ë¯¸ì§€ (ë¡œì»¬ Gateway):</h5>` +
                                    `<img src="${localUrl}" class="preview-image" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€">` +
                                    `<div class="mt-2 text-muted" style="font-size: 0.875rem;">` +
                                        `<div><strong>IPFS URI:</strong> <code>${ipfsUri}</code></div>` +
                                        `<div><strong>ì™¸ë¶€ Gateway:</strong> <a href="${externalUrl}" target="_blank">${externalUrl}</a></div>` +
                                    `</div>`
                            );
                        } else {
                            $("#uploaded-preview").empty();
                        }
                    },
                    function (message) {
                        setStatus(
                            "#upload-result",
                            `<strong>âœ— ì—…ë¡œë“œ ì‹¤íŒ¨</strong><br>${message}<br>IPFS ë°ëª¬ê³¼ CORS ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.`,
                            "error"
                        );
                    }
                );
            });

            const uploadMetadata = (imageHash) => {
                const metadata = {
                    name: "í…ŒìŠ¤íŠ¸ NFT",
                    description: "IPFS ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ìš© NFTì…ë‹ˆë‹¤.",
                    image: `${IPFS_GATEWAY_URL}${imageHash}`,
                    attributes: [
                        { trait_type: "í…ŒìŠ¤íŠ¸", value: "ì„±ê³µ" },
                        { trait_type: "ì¹´í…Œê³ ë¦¬", value: "í…ŒìŠ¤íŠ¸" }
                    ]
                };

                setStatus("#metadata-result", "ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì¤‘...", "info");

                const metadataBlob = new Blob([JSON.stringify(metadata)], { type: "application/json" });
                const formData = new FormData();
                formData.append("file", metadataBlob, "metadata.json");

                requestIPFS(
                    formData,
                    function (hash) {
                        const localUrl = `${IPFS_GATEWAY_URL}${hash}`;
                        const externalUrl = `${EXTERNAL_GATEWAY_URL}${hash}`;
                        const ipfsUri = `ipfs://${hash}`;
                        setStatus(
                            "#metadata-result",
                            `<strong>âœ“ ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì„±ê³µ!</strong><br><br>` +
                                `<strong>ë©”íƒ€ë°ì´í„° Hash:</strong><br><code>${hash}</code><br><br>` +
                                `<strong>IPFS URI:</strong><br><code>${ipfsUri}</code><br><br>` +
                                `<strong>ë©”íƒ€ë°ì´í„° URL:</strong><br><a href="${localUrl}" target="_blank">${localUrl}</a><br><br>` +
                                `<div class="code-block"><pre>${JSON.stringify(metadata, null, 2)}</pre></div>` +
                                `<div class="mt-2"><a href="${externalUrl}" target="_blank">ì™¸ë¶€ Gatewayì—ì„œ í™•ì¸í•˜ê¸°</a></div>`,
                            "success"
                        );
                    },
                    function (message) {
                        setStatus(
                            "#metadata-result",
                            `<strong>âœ— ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì‹¤íŒ¨</strong><br>${message}`,
                            "error"
                        );
                    }
                );
            };

            $(document).on("click", "#btn-test-metadata", function () {
                const imageHash = $(this).data("ipfs-hash") || uploadedHash;
                if (!imageHash) {
                    alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
                    return;
                }
                uploadMetadata(imageHash);
            });

            window.testMetadata = uploadMetadata;

            $("#btn-refresh").on("click", function () {
                checkIPFSStatus();
            });
        });
    </script>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-4">ğŸ§ª IPFS ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h1>

        <!-- IPFS ìƒíƒœ -->
        <div class="result-section">
            <h4>IPFS ì—°ê²° ìƒíƒœ</h4>
            <div id="ipfs-status">
                <div class="status info">í™•ì¸ ì¤‘...</div>
            </div>
            <button class="btn btn-sm btn-secondary mt-2" id="btn-refresh">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <!-- ì‚¬ìš© ì„¤ëª… -->
        <div class="alert alert-info mt-4">
            <strong>ğŸ“ ì‚¬ìš© ë°©ë²•:</strong>
            <ol class="mb-0 mt-2">
                <li>í„°ë¯¸ë„ì—ì„œ IPFS ë°ëª¬ ì‹¤í–‰: <code>ipfs daemon</code></li>
                <li>ì•„ë˜ì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</li>
                <li>"IPFSì— ì—…ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
                <li>ì—…ë¡œë“œ ì„±ê³µ í›„ "ë©”íƒ€ë°ì´í„° í…ŒìŠ¤íŠ¸" ë²„íŠ¼ìœ¼ë¡œ NFT ë©”íƒ€ë°ì´í„°ë„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            </ol>
        </div>

        <!-- íŒŒì¼ ì„ íƒ -->
        <div class="mb-4">
            <label for="uploadfile" class="form-label"><strong>íŒŒì¼ ì„ íƒ</strong></label>
            <input type="file" class="form-control" id="uploadfile" accept="image/*">
            <div id="file-info" class="mt-2"></div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° -->
        <div id="preview"></div>

        <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary btn-lg" id="btn-upload">ğŸš€ IPFSì— ì—…ë¡œë“œ</button>
        </div>

        <!-- ì—…ë¡œë“œ ê²°ê³¼ -->
        <div id="upload-result" class="mt-4"></div>

        <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
        <div id="uploaded-preview"></div>

        <!-- ë©”íƒ€ë°ì´í„° ê²°ê³¼ -->
        <div id="metadata-result" class="mt-4"></div>

        <!-- ì¶”ê°€ ì •ë³´ -->
        <div class="alert alert-secondary mt-4">
            <strong>ğŸ’¡ ì°¸ê³ :</strong>
            <ul class="mb-0 mt-2">
                <li><strong>ë¡œì»¬ Gateway:</strong> http://localhost:8080/ipfs/ (ë¹ ë¥´ì§€ë§Œ ë¡œì»¬ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥)</li>
                <li><strong>ì™¸ë¶€ Gateway:</strong> https://ipfs.io/ipfs/ (ëŠë¦¬ì§€ë§Œ ì–´ë””ì„œë‚˜ ì ‘ê·¼ ê°€ëŠ¥)</li>
                <li><strong>IPFS API:</strong> http://localhost:5001</li>
                <li>ì—…ë¡œë“œëœ íŒŒì¼ì€ IPFS ë„¤íŠ¸ì›Œí¬ì— ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>

</html>
